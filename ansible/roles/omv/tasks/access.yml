---
- name: Initialize effective SSH public key
  ansible.builtin.set_fact:
    omv_ssh_public_key_effective: ""

- name: Resolve OMV SSH public key from variable when explicitly set
  ansible.builtin.set_fact:
    omv_ssh_public_key_effective: "{{ omv_ssh_public_key | trim }}"
  when: omv_ssh_public_key | length > 0

- name: Check if controller public key file exists
  ansible.builtin.stat:
    path: "{{ omv_ssh_public_key_file | regex_replace('^~', lookup('ansible.builtin.env', 'HOME')) }}"
  register: omv_ssh_public_key_file_stat
  delegate_to: localhost
  become: false

- name: Resolve OMV SSH public key from controller file when available
  ansible.builtin.set_fact:
    omv_ssh_public_key_effective: >-
      {{
        lookup(
          'ansible.builtin.file',
          omv_ssh_public_key_file | regex_replace('^~', lookup('ansible.builtin.env', 'HOME'))
        ) | trim
      }}
  when:
    - omv_ssh_public_key_effective | length == 0
    - omv_ssh_public_key_file_stat.stat.exists

- name: Check if controller private key file exists
  ansible.builtin.stat:
    path: "{{ ansible_ssh_private_key_file | regex_replace('^~', lookup('ansible.builtin.env', 'HOME')) }}"
  register: omv_ssh_private_key_file_stat
  delegate_to: localhost
  become: false
  when: ansible_ssh_private_key_file is defined

- name: Resolve OMV SSH public key from controller private key when needed
  ansible.builtin.set_fact:
    omv_ssh_public_key_effective: >-
      {{
        lookup(
          'ansible.builtin.pipe',
          'ssh-keygen -y -f ' ~
          (
            ansible_ssh_private_key_file
            | regex_replace('^~', lookup('ansible.builtin.env', 'HOME'))
            | quote
          )
        )
        | trim
      }}
  when:
    - omv_ssh_public_key_effective | length == 0
    - ansible_ssh_private_key_file is defined
    - omv_ssh_private_key_file_stat.stat.exists

- name: Validate OMV SSH public key input
  ansible.builtin.assert:
    that:
      - omv_ssh_public_key_effective | length > 0
      - omv_ssh_public_key_effective is match('^(ssh-rsa|ssh-ed25519|ecdsa-sha2-nistp(256|384|521))\\s+')
    fail_msg: >-
      No SSH public key was resolved. Set `omv_ssh_public_key` or ensure
      `omv_ssh_public_key_file`/`ansible_ssh_private_key_file` exists on the Ansible controller.

- name: Ensure OMV SSH access group exists
  ansible.builtin.group:
    name: "{{ omv_ssh_group }}"
    state: present

- name: Ensure OMV admin user is in SSH access group
  ansible.builtin.user:
    name: "{{ omv_ssh_user }}"
    groups: "{{ omv_ssh_group }}"
    append: true

- name: Ensure OMV admin user authorized key is present
  ansible.posix.authorized_key:
    user: "{{ omv_ssh_user }}"
    key: "{{ omv_ssh_public_key_effective }}"
    state: present
    manage_dir: true
    exclusive: false
