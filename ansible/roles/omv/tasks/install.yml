---
- name: Remove legacy OMV repository entry without signed-by
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list.d/openmediavault.list
    regexp: '^deb\s+https?://packages\.openmediavault\.org/public/?\s+sandworm\s+main$'
    state: absent
  failed_when: false

- name: Ensure prerequisite packages are installed
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - ca-certificates
      - gnupg
      - wget
    state: present
    update_cache: true

- name: Add OpenMediaVault APT key
  ansible.builtin.apt_key:
    url: "{{ omv_key_url }}"
    state: present

- name: Add OpenMediaVault APT repository
  ansible.builtin.apt_repository:
    repo: "{{ omv_repo }}"
    state: present
    filename: openmediavault

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Install OpenMediaVault package
  ansible.builtin.apt:
    name: openmediavault
    state: present
  notify: Run omv-initsystem
